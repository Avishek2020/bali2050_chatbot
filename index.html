<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Digital Bad Lippspringe - Professional Chatbot</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts for clean typography -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Apply the modern font and a smooth background */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8; /* A light, clean blue-gray background */
        }

        /* Custom scrollbar for the messages area */
        #messages::-webkit-scrollbar {
            width: 6px;
        }
        #messages::-webkit-scrollbar-track {
            background: #e5e7eb;
            border-radius: 10px;
        }
        #messages::-webkit-scrollbar-thumb {
            background: #9ca3af;
            border-radius: 10px;
        }
        #messages::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
        
        /* Animation for the typing indicator dots */
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }
        .typing-dot {
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
    </style>
</head>
<body class="flex items-center justify-center h-screen">

    <!-- Main chat container with modern styling -->
    <div id="chatbox" class="w-full max-w-3xl h-[95%] sm:h-[90%] bg-white rounded-2xl shadow-2xl flex flex-col p-4 sm:p-6">

        <!-- Header section -->
        <header class="flex items-center gap-4 pb-4 border-b border-gray-200">
            <img src="https://raw.githubusercontent.com/Avishek2020/bali2050_chatbot/refs/heads/main/images/dbl_logo.png" alt="Logo" class="w-14 h-14 object-contain"/>
            <div>
                <h1 class="text-xl sm:text-2xl font-bold text-gray-800">Digital Bad Lippspringe</h1>
                <p class="text-sm text-gray-500">Ihr pers√∂nlicher KI-Assistent</p>
            </div>
        </header>

        <!-- Messages container -->
        <div id="messages" class="flex-1 overflow-y-auto py-6 px-2 space-y-6">
            <!-- Example Bot Message -->
            <div class="flex items-end gap-3">
                <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                </div>
                <div class="bg-gray-100 text-gray-800 p-3 rounded-lg rounded-bl-none shadow-sm max-w-md relative group">
                    <p class="text-sm">Hallo! Wie kann ich Ihnen heute helfen? Klicken Sie auf das Benutzersymbol, um Ihr Bild hochzuladen.</p>
                     <button class="speak-button absolute top-1 right-1 p-1 bg-white rounded-full text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="speakText('Hallo! Wie kann ich Ihnen heute helfen? Klicken Sie auf das Benutzersymbol, um Ihr Bild hochzuladen.')">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Typing indicator (hidden by default) -->
        <div id="typing-indicator" class="hidden flex items-end gap-3 px-2 pb-4">
             <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
                <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
            </div>
            <div class="bg-gray-100 text-gray-800 p-3 rounded-lg rounded-bl-none shadow-sm flex items-center space-x-1.5">
                <div class="typing-dot w-2 h-2 bg-gray-500 rounded-full"></div>
                <div class="typing-dot w-2 h-2 bg-gray-500 rounded-full"></div>
                <div class="typing-dot w-2 h-2 bg-gray-500 rounded-full"></div>
            </div>
        </div>

        <!-- Input area -->
        <div class="pt-4 border-t border-gray-200">
            <div class="flex items-center bg-gray-100 rounded-xl p-2">
                <input id="userInput" type="text" placeholder="Stellen Sie Ihre Frage..." class="flex-1 bg-transparent border-none text-gray-800 placeholder-gray-500 focus:ring-0 text-sm px-3"/>
                <button id="micBtn" class="p-2 text-gray-500 hover:text-blue-600 transition-colors rounded-lg">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path></svg>
                </button>
                <button id="sendBtn" class="p-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 active:scale-95 transition-all shadow">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Hidden file input for icon upload -->
    <input type="file" id="iconUpload" class="hidden" accept="image/*">

    <script>
        // --- Element References ---
        const msgBox = document.getElementById('messages');
        const userInput = document.getElementById('userInput');
        const sendBtn = document.getElementById('sendBtn');
        const micBtn = document.getElementById('micBtn');
        const typingIndicator = document.getElementById('typing-indicator');
        const iconUploadInput = document.getElementById('iconUpload');

        // --- State ---
        let isListening = false;
        let userIconSrc = null; // Start with no specific icon

        // --- Speech Synthesis and Recognition Setup ---
        const synth = window.speechSynthesis;
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = SpeechRecognition ? new SpeechRecognition() : null;
        
        if (recognition) {
            recognition.continuous = false;
            recognition.lang = "de-DE";
            recognition.interimResults = false;
        }
        
        // Pre-load voices
        if (synth) {
            synth.onvoiceschanged = () => {
                synth.getVoices();
            };
        }
        
        // --- Event Listeners ---
        sendBtn.addEventListener('click', sendMessage);
        micBtn.addEventListener('click', toggleListening);
        userInput.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
                event.preventDefault();
                sendMessage();
            }
        });
        iconUploadInput.addEventListener('change', handleIconUpload);

        // --- Core Functions ---
        function appendMessage(sender, text) {
            let messageHtml = '';
            const sanitizedText = text.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>");

            if (sender === 'user') {
                const iconHtml = userIconSrc 
                    ? `<img src="${userIconSrc}" class="w-8 h-8 rounded-full object-cover">`
                    : `<div class="w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center flex-shrink-0 text-gray-600 font-semibold">U</div>`;
                
                messageHtml = `
                    <div class="flex items-end justify-end gap-3">
                        <div class="bg-blue-500 text-white p-3 rounded-lg rounded-br-none shadow-sm max-w-md">
                            <p class="text-sm">${sanitizedText}</p>
                        </div>
                        <label for="iconUpload" class="cursor-pointer user-icon-container">
                           ${iconHtml}
                        </label>
                    </div>`;
            } else { // bot
                const botTextForSpeech = text.replace(/`/g, "\\`").replace(/"/g, '\\"');
                messageHtml = `
                    <div class="flex items-end gap-3">
                        <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
                        </div>
                        <div class="bg-gray-100 text-gray-800 p-3 rounded-lg rounded-bl-none shadow-sm max-w-md relative group">
                            <p class="text-sm">${sanitizedText}</p>
                            <button class="speak-button absolute top-1 right-1 p-1 bg-white rounded-full text-gray-400 hover:text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity" onclick="speakText(\`${botTextForSpeech}\`)">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd"></path></svg>
                            </button>
                        </div>
                    </div>`;
            }
            msgBox.insertAdjacentHTML('beforeend', messageHtml);
            msgBox.scrollTop = msgBox.scrollHeight;
        }
        
        function handleIconUpload(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    userIconSrc = e.target.result;
                    // Update all existing user icons
                    document.querySelectorAll('.user-icon-container').forEach(container => {
                        container.innerHTML = `<img src="${userIconSrc}" class="w-8 h-8 rounded-full object-cover">`;
                    });
                };
                reader.readAsDataURL(file);
            }
        }

        async function sendMessage() {
            const userMsg = userInput.value.trim();
            if (!userMsg) return;

            appendMessage('user', userMsg);
            userInput.value = "";
            typingIndicator.classList.remove('hidden');

            try {
                const response = await fetch("https://bali2050-chatbot.onrender.com/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ message: userMsg })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const botText = data.response;
                
                typingIndicator.classList.add('hidden');
                appendMessage('bot', botText);

            } catch (err) {
                console.error("Error fetching bot response:", err);
                typingIndicator.classList.add('hidden');
                appendMessage('bot', `Entschuldigung, es ist ein Fehler aufgetreten: ${err.message}`);
            }
        }

        function speakText(text) {
            if (!synth || !text) return;
            if (synth.speaking) {
                synth.cancel();
            }
            const utter = new SpeechSynthesisUtterance(text);
            const isGerman = /[√§√∂√º√ü]|(\bder\b|\bdie\b|\bdas\b|\bein\b|\bist\b|\bund\b)/i.test(text);
            utter.lang = isGerman ? "de-DE" : "en-US";
            
            const voices = synth.getVoices();
            const preferredVoice = voices.find(v => v.lang === utter.lang && v.name.includes('Google'));
            utter.voice = preferredVoice || voices.find(v => v.lang === utter.lang);
            
            synth.speak(utter);
        }

        function toggleListening() {
            if (!recognition) {
                alert("Spracherkennung wird von diesem Browser nicht unterst√ºtzt.");
                return;
            }
            if (isListening) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }

        if (recognition) {
            // --- Recognition Event Handlers ---
            recognition.onstart = () => {
                isListening = true;
                micBtn.classList.add('text-red-500', 'animate-pulse');
            };

            recognition.onend = () => {
                isListening = false;
                micBtn.classList.remove('text-red-500', 'animate-pulse');
            };
            
            recognition.onerror = (event) => {
                console.error("Fehler bei der Spracherkennung:", event.error);
                isListening = false;
                micBtn.classList.remove('text-red-500', 'animate-pulse');
            };

            recognition.onresult = (event) => {
                const spokenText = event.results[0][0].transcript;
                userInput.value = spokenText;
                if (spokenText) {
                   sendMessage();
                }
            };
        }
    </script>
</body>
</html>
